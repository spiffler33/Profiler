{% extends "admin/base_admin.html" %}

{% block title %}Parameter Management{% endblock %}
{% block page_title %}Parameter Management{% endblock %}

{% block extra_css %}
<style>
    /* Parameter visualization styles */
    .parameter-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .parameter-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
    }
    
    .parameter-category {
        font-weight: 600;
        color: #007bff;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
    
    .parameter-path {
        font-family: 'Courier New', monospace;
        color: #495057;
        font-size: 0.9rem;
    }
    
    .parameter-value {
        font-weight: 600;
    }
    
    .parameter-relationships {
        position: relative;
        height: 400px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 20px;
    }
    
    .documentation-panel {
        height: 100%;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
    }
    
    .audit-entry {
        font-size: 0.85rem;
        padding: 8px 0;
        border-bottom: 1px solid #f1f1f1;
    }
    
    .audit-timestamp {
        color: #6c757d;
        font-size: 0.8rem;
    }
    
    .audit-change .old-value {
        color: #dc3545;
        text-decoration: line-through;
    }
    
    .audit-change .new-value {
        color: #28a745;
    }
    
    .parameter-overview {
        padding: 20px;
        background-color: #fff;
        border-radius: 0.25rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        margin-bottom: 20px;
    }
    
    .tab-content {
        padding: 20px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 0.25rem 0.25rem;
    }
    
    .parameter-filter {
        margin-bottom: 20px;
    }
    
    .user-preference-toggle {
        margin-right: 10px;
    }
    
    .parameter-tree {
        max-height: 500px;
        overflow-y: auto;
    }
    
    /* Network graph styles */
    .parameter-node {
        cursor: pointer;
    }
    
    .parameter-link {
        stroke: #999;
        stroke-opacity: 0.6;
    }
    
    .node-tooltip {
        position: absolute;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        font-size: 0.8rem;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 10;
    }
    
    /* Parameter editing styles */
    .edit-form {
        display: none;
        margin-top: 10px;
    }
    
    .edit-parameter {
        cursor: pointer;
        color: #007bff;
    }
    
    .parameter-history {
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.85rem;
    }
    
    /* Search and filter */
    .search-box {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-admin">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Financial Parameters Overview</h5>
                    <div>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addParameterModal">
                            <i class="bi bi-plus-circle"></i> Add Parameter
                        </button>
                        <button class="btn btn-sm btn-secondary" id="refreshParameters">
                            <i class="bi bi-arrow-repeat"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> The parameter system manages all financial constants, market assumptions, tax rules, and other configuration values used throughout the application.
                    </div>
                    
                    <div class="row parameter-filter">
                        <div class="col-md-6">
                            <div class="input-group search-box">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="parameterSearch" placeholder="Search parameters...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="asset_returns">Asset Returns</option>
                                <option value="inflation">Inflation</option>
                                <option value="retirement">Retirement</option>
                                <option value="education">Education</option>
                                <option value="housing">Housing</option>
                                <option value="tax">Tax</option>
                                <option value="risk_profiles">Risk Profiles</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showUserOverrides">
                                <label class="form-check-label" for="showUserOverrides">Show User Overrides</label>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="nav nav-tabs" id="parameterTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid" type="button" role="tab" aria-controls="grid" aria-selected="true">Grid View</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tree-tab" data-bs-toggle="tab" data-bs-target="#tree" type="button" role="tab" aria-controls="tree" aria-selected="false">Tree View</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="relationships-tab" data-bs-toggle="tab" data-bs-target="#relationships" type="button" role="tab" aria-controls="relationships" aria-selected="false">Relationships</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab" aria-controls="audit" aria-selected="false">Audit Log</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="parameterTabsContent">
                        <!-- Grid View Tab -->
                        <div class="tab-pane fade show active" id="grid" role="tabpanel" aria-labelledby="grid-tab">
                            <div class="row" id="parameters-grid">
                                <!-- Parameters will be loaded here -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading parameters...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tree View Tab -->
                        <div class="tab-pane fade" id="tree" role="tabpanel" aria-labelledby="tree-tab">
                            <div class="parameter-tree" id="parameter-tree">
                                <!-- Parameter tree will be loaded here -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading parameter tree...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Relationships Tab -->
                        <div class="tab-pane fade" id="relationships" role="tabpanel" aria-labelledby="relationships-tab">
                            <div class="parameter-relationships" id="parameter-graph">
                                <!-- Parameter relationships graph will be loaded here -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading parameter relationships...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audit Log Tab -->
                        <div class="tab-pane fade" id="audit" role="tabpanel" aria-labelledby="audit-tab">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="auditSearch" placeholder="Filter audit log...">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="auditActionFilter">
                                        <option value="">All Actions</option>
                                        <option value="access">Access</option>
                                        <option value="change">Change</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-secondary w-100" id="refreshAudit">
                                        <i class="bi bi-arrow-repeat"></i> Refresh Log
                                    </button>
                                </div>
                            </div>
                            
                            <div id="audit-log">
                                <!-- Audit log will be loaded here -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading audit log...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Parameter Documentation Panel -->
        <div class="col-md-6">
            <div class="card-admin">
                <div class="card-header">
                    <h5 class="mb-0">Parameter Documentation</h5>
                </div>
                <div class="card-body">
                    <div class="documentation-panel" id="parameter-documentation">
                        <div class="text-center py-5">
                            <p>Select a parameter to view documentation</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Preference Controls -->
        <div class="col-md-6">
            <div class="card-admin">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">User Parameter Overrides</h5>
                    <div class="form-group mb-0">
                        <select class="form-select form-select-sm" id="profileSelector">
                            <option value="">Select a profile</option>
                            <!-- Profile options will be loaded here -->
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="user-parameters">
                        <div class="text-center py-5">
                            <p>Select a profile to view parameter overrides</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Parameter Modal -->
<div class="modal fade" id="addParameterModal" tabindex="-1" aria-labelledby="addParameterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addParameterModalLabel">Add New Parameter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addParameterForm">
                    <div class="mb-3">
                        <label for="parameterPath" class="form-label">Parameter Path</label>
                        <input type="text" class="form-control" id="parameterPath" placeholder="e.g., asset_returns.equity.large_cap.value" required>
                        <div class="form-text">Use dot notation to specify the parameter path in the hierarchy.</div>
                    </div>
                    <div class="mb-3">
                        <label for="parameterValue" class="form-label">Value</label>
                        <input type="text" class="form-control" id="parameterValue" required>
                    </div>
                    <div class="mb-3">
                        <label for="parameterDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="parameterDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="parameterSource" class="form-label">Source</label>
                        <input type="text" class="form-control" id="parameterSource" placeholder="e.g., admin, system, research" value="admin">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="parameterIsEditable" checked>
                            <label class="form-check-label" for="parameterIsEditable">
                                User Editable
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveParameter">Save Parameter</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Parameter Modal -->
<div class="modal fade" id="editParameterModal" tabindex="-1" aria-labelledby="editParameterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editParameterModalLabel">Edit Parameter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editParameterForm">
                    <input type="hidden" id="editParameterPath">
                    <div class="mb-3">
                        <label for="editParameterDisplay" class="form-label">Parameter Path</label>
                        <input type="text" class="form-control" id="editParameterDisplay" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="editParameterValue" class="form-label">Value</label>
                        <input type="text" class="form-control" id="editParameterValue" required>
                    </div>
                    <div class="mb-3">
                        <label for="editParameterDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editParameterDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editParameterSource" class="form-label">Source</label>
                        <input type="text" class="form-control" id="editParameterSource" value="admin">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editParameterIsEditable">
                            <label class="form-check-label" for="editParameterIsEditable">
                                User Editable
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Parameter History</h6>
                        <div class="parameter-history" id="parameter-history">
                            <p class="text-muted">No history available</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deleteParameter">Delete</button>
                <button type="button" class="btn btn-primary" id="updateParameter">Update Parameter</button>
            </div>
        </div>
    </div>
</div>

<!-- Parameter Detail Modal -->
<div class="modal fade" id="parameterDetailModal" tabindex="-1" aria-labelledby="parameterDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="parameterDetailModalLabel">Parameter Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <dl class="row">
                            <dt class="col-sm-4">Path</dt>
                            <dd class="col-sm-8" id="detail-path"></dd>
                            
                            <dt class="col-sm-4">Value</dt>
                            <dd class="col-sm-8" id="detail-value"></dd>
                            
                            <dt class="col-sm-4">Type</dt>
                            <dd class="col-sm-8" id="detail-type"></dd>
                            
                            <dt class="col-sm-4">Source</dt>
                            <dd class="col-sm-8" id="detail-source"></dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6>Metadata</h6>
                        <dl class="row">
                            <dt class="col-sm-4">Description</dt>
                            <dd class="col-sm-8" id="detail-description"></dd>
                            
                            <dt class="col-sm-4">Last Updated</dt>
                            <dd class="col-sm-8" id="detail-updated"></dd>
                            
                            <dt class="col-sm-4">Created</dt>
                            <dd class="col-sm-8" id="detail-created"></dd>
                        </dl>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Related Parameters</h6>
                    <div id="related-parameters" class="mb-3">
                        <p class="text-muted">No related parameters found</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Usage Count</h6>
                    <div id="usage-chart" style="height: 200px;">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editFromDetail">Edit Parameter</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<!-- API service components -->
{% if 'api_service' not in request.args or request.args.get('api_service') != 'disable' %}
<script src="{{ url_for('static', filename='js/services/ErrorHandlingService.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/LoadingStateManager.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/dataEventBus.js') }}"></script>
<script src="{{ url_for('static', filename='js/services/ParameterAdminService.js') }}"></script>
{% endif %}

<!-- Parameter admin integration -->
<script src="{{ url_for('static', filename='js/parameter_admin_integration.js') }}"></script>

<script>
    // Main parameter data
    let allParameters = [];
    let parameterTree = {};
    let selectedParameter = null;
    let allProfiles = [];
    
    // DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        // Load initial data
        loadParameters();
        loadProfiles();
        setupEventListeners();
    });
    
    // Setup event listeners
    function setupEventListeners() {
        // Search functionality
        document.getElementById('parameterSearch').addEventListener('input', filterParameters);
        document.getElementById('categoryFilter').addEventListener('change', filterParameters);
        document.getElementById('showUserOverrides').addEventListener('change', filterParameters);
        
        // Tab switching
        document.getElementById('relationships-tab').addEventListener('click', function() {
            // Initialize D3 visualization when tab is first shown
            setTimeout(() => {
                if (!document.querySelector('#parameter-graph svg')) {
                    initializeRelationshipGraph();
                }
            }, 100);
        });
        
        // Refresh buttons
        document.getElementById('refreshParameters').addEventListener('click', loadParameters);
        document.getElementById('refreshAudit').addEventListener('click', loadAuditLog);
        
        // Profile selector
        document.getElementById('profileSelector').addEventListener('change', function() {
            const profileId = this.value;
            if (profileId) {
                loadUserParameters(profileId);
            } else {
                document.getElementById('user-parameters').innerHTML = '<div class="text-center py-5"><p>Select a profile to view parameter overrides</p></div>';
            }
        });
        
        // Parameter form actions
        document.getElementById('saveParameter').addEventListener('click', saveParameter);
        document.getElementById('updateParameter').addEventListener('click', updateParameter);
        document.getElementById('deleteParameter').addEventListener('click', deleteParameter);
        document.getElementById('editFromDetail').addEventListener('click', function() {
            $('#parameterDetailModal').modal('hide');
            setTimeout(() => {
                editParameter(selectedParameter);
            }, 500);
        });
        
        // Audit log filtering
        document.getElementById('auditSearch').addEventListener('input', filterAuditLog);
        document.getElementById('auditActionFilter').addEventListener('change', filterAuditLog);
    }
    
    // Load all parameters
    function loadParameters() {
        fetch('/api/admin/parameters')
            .then(response => response.json())
            .then(data => {
                allParameters = data.parameters;
                parameterTree = data.tree;
                
                // Update UI
                renderParameterGrid(allParameters);
                renderParameterTree(parameterTree);
                loadAuditLog();
            })
            .catch(error => {
                console.error('Error loading parameters:', error);
                document.getElementById('parameters-grid').innerHTML = 
                    '<div class="col-12"><div class="alert alert-danger">Error loading parameters. Please try again.</div></div>';
            });
    }
    
    // Load all profiles
    function loadProfiles() {
        fetch('/api/admin/profiles')
            .then(response => response.json())
            .then(data => {
                allProfiles = data;
                const selector = document.getElementById('profileSelector');
                
                // Clear existing options
                selector.innerHTML = '<option value="">Select a profile</option>';
                
                // Add profiles
                data.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = profile.name;
                    selector.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading profiles:', error);
            });
    }
    
    // Load user-specific parameters
    function loadUserParameters(profileId) {
        fetch(`/api/admin/parameters/user/${profileId}`)
            .then(response => response.json())
            .then(data => {
                renderUserParameters(data, profileId);
            })
            .catch(error => {
                console.error('Error loading user parameters:', error);
                document.getElementById('user-parameters').innerHTML = 
                    '<div class="alert alert-danger">Error loading user parameter overrides. Please try again.</div>';
            });
    }
    
    // Load audit log
    function loadAuditLog() {
        fetch('/api/admin/parameters/audit')
            .then(response => response.json())
            .then(data => {
                renderAuditLog(data);
            })
            .catch(error => {
                console.error('Error loading audit log:', error);
                document.getElementById('audit-log').innerHTML = 
                    '<div class="alert alert-danger">Error loading audit log. Please try again.</div>';
            });
    }
    
    // Render parameter grid
    function renderParameterGrid(parameters) {
        const container = document.getElementById('parameters-grid');
        
        // Clear previous content
        container.innerHTML = '';
        
        if (parameters.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-info">No parameters found matching your criteria.</div></div>';
            return;
        }
        
        // Group parameters by top-level category
        const grouped = {};
        parameters.forEach(param => {
            const topLevel = param.path.split('.')[0];
            if (!grouped[topLevel]) {
                grouped[topLevel] = [];
            }
            grouped[topLevel].push(param);
        });
        
        // Render each category
        Object.keys(grouped).sort().forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'col-12 mb-4';
            
            categoryDiv.innerHTML = `
                <h5 class="parameter-category">${formatCategoryName(category)}</h5>
                <div class="row" id="category-${category}"></div>
            `;
            
            container.appendChild(categoryDiv);
            
            const categoryContainer = document.getElementById(`category-${category}`);
            
            // Sort parameters by path
            grouped[category].sort((a, b) => a.path.localeCompare(b.path)).forEach(param => {
                const card = document.createElement('div');
                card.className = 'col-lg-4 col-md-6 mb-3';
                
                card.innerHTML = `
                    <div class="card parameter-card" data-parameter="${param.path}">
                        <div class="card-body">
                            <h6 class="card-title">${getParameterName(param.path)}</h6>
                            <p class="parameter-path mb-2">${param.path}</p>
                            <p class="parameter-value mb-0">
                                <span class="badge bg-light text-dark">${typeof param.value}</span>
                                <span class="ms-2">${formatParameterValue(param.value)}</span>
                            </p>
                        </div>
                    </div>
                `;
                
                categoryContainer.appendChild(card);
                
                // Add click event
                card.querySelector('.parameter-card').addEventListener('click', function() {
                    showParameterDetails(param);
                });
            });
        });
    }
    
    // Render parameter tree view
    function renderParameterTree(tree) {
        const container = document.getElementById('parameter-tree');
        container.innerHTML = '';
        
        const treeData = convertToTreeData(tree);
        renderTreeNode(container, treeData, 0);
    }
    
    // Render a single tree node and its children
    function renderTreeNode(parent, node, level) {
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'tree-node';
        nodeDiv.style.paddingLeft = `${level * 20}px`;
        
        // Handle leaf nodes with values
        if (node.value !== undefined) {
            nodeDiv.innerHTML = `
                <div class="d-flex align-items-center py-2 border-bottom">
                    <span class="me-2">${node.name}:</span>
                    <span class="badge bg-light text-dark me-2">${typeof node.value}</span>
                    <span class="parameter-value">${formatParameterValue(node.value)}</span>
                    <a href="#" class="ms-auto edit-parameter" data-path="${node.path}">
                        <i class="bi bi-pencil-square"></i>
                    </a>
                </div>
            `;
            
            // Add click event for parameter editing
            nodeDiv.querySelector('.edit-parameter').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const paramPath = this.getAttribute('data-path');
                const param = allParameters.find(p => p.path === paramPath);
                if (param) {
                    editParameter(param);
                }
            });
        } else {
            // This is an internal node (directory/category)
            const isExpanded = level < 1; // Auto-expand first level
            
            nodeDiv.innerHTML = `
                <div class="d-flex align-items-center py-2 border-bottom">
                    <i class="bi ${isExpanded ? 'bi-dash-square' : 'bi-plus-square'} me-2 toggle-node" 
                       style="cursor: pointer;"></i>
                    <span class="fw-bold">${node.name}</span>
                </div>
                <div class="children" style="display: ${isExpanded ? 'block' : 'none'};"></div>
            `;
            
            // Add toggle event
            nodeDiv.querySelector('.toggle-node').addEventListener('click', function() {
                const childrenDiv = nodeDiv.querySelector('.children');
                const isVisible = childrenDiv.style.display !== 'none';
                
                childrenDiv.style.display = isVisible ? 'none' : 'block';
                this.classList.remove(isVisible ? 'bi-dash-square' : 'bi-plus-square');
                this.classList.add(isVisible ? 'bi-plus-square' : 'bi-dash-square');
            });
            
            // Render children
            const childrenContainer = nodeDiv.querySelector('.children');
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    renderTreeNode(childrenContainer, child, level + 1);
                });
            }
        }
        
        parent.appendChild(nodeDiv);
    }
    
    // Render the parameter relationship graph
    function initializeRelationshipGraph() {
        const width = document.getElementById('parameter-graph').clientWidth;
        const height = document.getElementById('parameter-graph').clientHeight;
        
        // Create SVG container
        const svg = d3.select('#parameter-graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
        
        // Create tooltip
        const tooltip = d3.select('#parameter-graph')
            .append('div')
            .attr('class', 'node-tooltip');
        
        // Convert parameter data to nodes and links
        const graphData = createGraphData(parameterTree);
        
        // Create simulation
        const simulation = d3.forceSimulation(graphData.nodes)
            .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
            .force('charge', d3.forceManyBody().strength(-200))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(30));
        
        // Create links
        const link = svg.append('g')
            .selectAll('line')
            .data(graphData.links)
            .enter()
            .append('line')
            .attr('class', 'parameter-link');
        
        // Create nodes
        const node = svg.append('g')
            .selectAll('circle')
            .data(graphData.nodes)
            .enter()
            .append('circle')
            .attr('class', 'parameter-node')
            .attr('r', d => d.isLeaf ? 5 : 10)
            .attr('fill', d => getNodeColor(d))
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));
        
        // Node events
        node.on('mouseover', function(event, d) {
                d3.select(this).attr('stroke', '#333').attr('stroke-width', 2);
                
                tooltip.transition()
                    .duration(200)
                    .style('opacity', .9);
                    
                tooltip.html(`
                    <strong>${d.name}</strong><br>
                    ${d.isLeaf ? `Value: ${formatParameterValue(d.value)}` : 'Category'}
                `)
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 28) + 'px');
            })
            .on('mouseout', function() {
                d3.select(this).attr('stroke', null);
                
                tooltip.transition()
                    .duration(500)
                    .style('opacity', 0);
            })
            .on('click', function(event, d) {
                if (d.isLeaf) {
                    const param = allParameters.find(p => p.path === d.id);
                    if (param) {
                        showParameterDetails(param);
                    }
                }
            });
        
        // Add labels
        const labels = svg.append('g')
            .selectAll('text')
            .data(graphData.nodes)
            .enter()
            .append('text')
            .text(d => d.name)
            .attr('font-size', '8px')
            .attr('dx', 12)
            .attr('dy', 4);
        
        // Simulation tick
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
                
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
                
            labels
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }
    
    // Render the audit log
    function renderAuditLog(entries) {
        const container = document.getElementById('audit-log');
        container.innerHTML = '';
        
        if (entries.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No audit log entries found.</div>';
            return;
        }
        
        // Create the log entries
        entries.forEach(entry => {
            const logEntry = document.createElement('div');
            logEntry.className = `audit-entry ${entry.action}-action`;
            
            let entryContent = `
                <div class="d-flex justify-content-between align-items-top">
                    <div>
                        <span class="badge ${entry.action === 'access' ? 'bg-info' : 'bg-warning text-dark'} me-2">
                            ${entry.action}
                        </span>
                        <span class="parameter-path">${entry.parameter}</span>
                    </div>
                    <span class="audit-timestamp">${formatDate(entry.timestamp)}</span>
                </div>
            `;
            
            // Add change details if applicable
            if (entry.action === 'change') {
                entryContent += `
                    <div class="audit-change mt-1 ps-4">
                        <span class="old-value">${entry.old_value}</span>
                        <i class="bi bi-arrow-right mx-2"></i>
                        <span class="new-value">${entry.new_value}</span>
                        <small class="ms-2 text-muted">${entry.source || 'system'}</small>
                    </div>
                `;
                
                if (entry.description) {
                    entryContent += `<div class="ps-4 text-muted small">${entry.description}</div>`;
                }
            }
            
            logEntry.innerHTML = entryContent;
            container.appendChild(logEntry);
            
            // Add click event to show parameter details
            logEntry.addEventListener('click', function() {
                const param = allParameters.find(p => p.path === entry.parameter);
                if (param) {
                    showParameterDetails(param);
                }
            });
        });
    }
    
    // Render user parameter overrides
    function renderUserParameters(parameters, profileId) {
        const container = document.getElementById('user-parameters');
        
        if (Object.keys(parameters).length === 0) {
            container.innerHTML = '<div class="alert alert-info">No parameter overrides found for this profile.</div>';
            return;
        }
        
        // Create override table
        const table = document.createElement('table');
        table.className = 'table table-sm';
        
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th>Global Value</th>
                    <th>Override Value</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="overrides-body"></tbody>
        `;
        
        container.innerHTML = '';
        container.appendChild(table);
        
        const tbody = document.getElementById('overrides-body');
        
        // Add each override
        Object.keys(parameters).sort().forEach(path => {
            const override = parameters[path];
            const globalParam = allParameters.find(p => p.path === path);
            
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>
                    <span class="parameter-path">${path}</span>
                </td>
                <td>
                    ${globalParam ? formatParameterValue(globalParam.value) : 'N/A'}
                </td>
                <td>
                    ${formatParameterValue(override)}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary edit-override" 
                            data-path="${path}" data-value="${override}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger reset-override" 
                            data-path="${path}">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // Add event listeners
            row.querySelector('.edit-override').addEventListener('click', function() {
                editUserOverride(profileId, path, override);
            });
            
            row.querySelector('.reset-override').addEventListener('click', function() {
                resetUserOverride(profileId, path);
            });
        });
    }
    
    // Show parameter details
    function showParameterDetails(parameter) {
        selectedParameter = parameter;
        
        // Populate detail modal
        document.getElementById('detail-path').textContent = parameter.path;
        document.getElementById('detail-value').textContent = formatParameterValue(parameter.value);
        document.getElementById('detail-type').textContent = typeof parameter.value;
        document.getElementById('detail-source').textContent = parameter.source || 'system';
        document.getElementById('detail-description').textContent = parameter.description || 'No description available';
        document.getElementById('detail-updated').textContent = parameter.last_updated ? formatDate(parameter.last_updated) : 'Unknown';
        document.getElementById('detail-created').textContent = parameter.created ? formatDate(parameter.created) : 'Unknown';
        
        // Update the documentation panel
        updateDocumentationPanel(parameter);
        
        // Find related parameters
        findRelatedParameters(parameter.path);
        
        // Show modal
        $('#parameterDetailModal').modal('show');
    }
    
    // Edit parameter
    function editParameter(parameter) {
        document.getElementById('editParameterPath').value = parameter.path;
        document.getElementById('editParameterDisplay').value = parameter.path;
        document.getElementById('editParameterValue').value = parameter.value;
        document.getElementById('editParameterDescription').value = parameter.description || '';
        document.getElementById('editParameterSource').value = parameter.source || 'admin';
        document.getElementById('editParameterIsEditable').checked = parameter.is_editable !== false;
        
        // Load parameter history
        fetch(`/api/admin/parameters/history/${encodeURIComponent(parameter.path)}`)
            .then(response => response.json())
            .then(data => {
                renderParameterHistory(data);
            })
            .catch(error => {
                console.error('Error loading parameter history:', error);
                document.getElementById('parameter-history').innerHTML = '<p class="text-muted">Failed to load history</p>';
            });
        
        // Show modal
        $('#editParameterModal').modal('show');
    }
    
    // Edit user parameter override
    function editUserOverride(profileId, path, value) {
        // Create a simple form for editing
        const valueString = typeof value === 'object' ? JSON.stringify(value) : String(value);
        
        const form = document.createElement('div');
        form.className = 'mb-3';
        form.innerHTML = `
            <input type="text" class="form-control mb-2" id="override-value" 
                   value="${valueString}">
            <div class="d-flex justify-content-end">
                <button class="btn btn-sm btn-secondary me-2" id="cancel-override">Cancel</button>
                <button class="btn btn-sm btn-primary" id="save-override">Save</button>
            </div>
        `;
        
        // Find the cell to replace
        const overrideCell = document.querySelector(`button[data-path="${path}"]`).closest('tr').cells[2];
        const originalContent = overrideCell.innerHTML;
        
        // Replace with form
        overrideCell.innerHTML = '';
        overrideCell.appendChild(form);
        
        // Add event listeners
        document.getElementById('cancel-override').addEventListener('click', function() {
            overrideCell.innerHTML = originalContent;
        });
        
        document.getElementById('save-override').addEventListener('click', function() {
            const newValue = document.getElementById('override-value').value;
            updateUserOverride(profileId, path, newValue);
        });
    }
    
    // Update user parameter override
    function updateUserOverride(profileId, path, value) {
        fetch(`/api/admin/parameters/user/${profileId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path, value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUserParameters(profileId);
            } else {
                alert('Failed to update parameter override: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error updating user parameter:', error);
            alert('An error occurred while updating the parameter override.');
        });
    }
    
    // Reset user parameter override
    function resetUserOverride(profileId, path) {
        if (!confirm(`Reset the override for ${path} to global value?`)) {
            return;
        }
        
        fetch(`/api/admin/parameters/user/${profileId}/reset`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUserParameters(profileId);
            } else {
                alert('Failed to reset parameter override: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error resetting user parameter:', error);
            alert('An error occurred while resetting the parameter override.');
        });
    }
    
    // Save new parameter
    function saveParameter() {
        const path = document.getElementById('parameterPath').value;
        const value = document.getElementById('parameterValue').value;
        const description = document.getElementById('parameterDescription').value;
        const source = document.getElementById('parameterSource').value;
        const isEditable = document.getElementById('parameterIsEditable').checked;
        
        if (!path || !value) {
            alert('Parameter path and value are required');
            return;
        }
        
        const paramData = {
            path,
            value: parseParameterValue(value),
            description,
            source,
            is_editable: isEditable
        };
        
        fetch('/api/admin/parameters', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paramData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#addParameterModal').modal('hide');
                document.getElementById('addParameterForm').reset();
                loadParameters();
            } else {
                alert('Failed to save parameter: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving parameter:', error);
            alert('An error occurred while saving the parameter.');
        });
    }
    
    // Update existing parameter
    function updateParameter() {
        const path = document.getElementById('editParameterPath').value;
        const value = document.getElementById('editParameterValue').value;
        const description = document.getElementById('editParameterDescription').value;
        const source = document.getElementById('editParameterSource').value;
        const isEditable = document.getElementById('editParameterIsEditable').checked;
        
        if (!path || !value) {
            alert('Parameter path and value are required');
            return;
        }
        
        const paramData = {
            value: parseParameterValue(value),
            description,
            source,
            is_editable: isEditable
        };
        
        fetch(`/api/admin/parameters/${encodeURIComponent(path)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paramData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#editParameterModal').modal('hide');
                loadParameters();
            } else {
                alert('Failed to update parameter: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error updating parameter:', error);
            alert('An error occurred while updating the parameter.');
        });
    }
    
    // Delete parameter
    function deleteParameter() {
        const path = document.getElementById('editParameterPath').value;
        
        if (!confirm(`Are you sure you want to delete the parameter: ${path}? This action cannot be undone.`)) {
            return;
        }
        
        fetch(`/api/admin/parameters/${encodeURIComponent(path)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#editParameterModal').modal('hide');
                loadParameters();
            } else {
                alert('Failed to delete parameter: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting parameter:', error);
            alert('An error occurred while deleting the parameter.');
        });
    }
    
    // Update the documentation panel
    function updateDocumentationPanel(parameter) {
        const panel = document.getElementById('parameter-documentation');
        
        panel.innerHTML = `
            <h4 class="mb-3">${getParameterName(parameter.path)}</h4>
            <p class="parameter-path mb-4">${parameter.path}</p>
            
            <div class="mb-4">
                <h5>Current Value</h5>
                <div class="p-3 bg-light rounded">
                    <span class="badge bg-secondary me-2">${typeof parameter.value}</span>
                    <span>${formatParameterValue(parameter.value)}</span>
                </div>
            </div>
            
            <div class="mb-4">
                <h5>Description</h5>
                <p>${parameter.description || 'No description available for this parameter.'}</p>
            </div>
            
            <div class="mb-4">
                <h5>Impact & Usage</h5>
                <p>This parameter affects the following calculations:</p>
                <ul id="impact-list">
                    <li>Loading impact information...</li>
                </ul>
            </div>
            
            <div class="mb-4">
                <h5>Historical Values</h5>
                <div id="history-chart" style="height: 200px;">
                    <!-- Chart will be rendered here -->
                </div>
            </div>
            
            <div class="mb-4">
                <h5>Metadata</h5>
                <table class="table table-sm">
                    <tr>
                        <td>Source</td>
                        <td>${parameter.source || 'system'}</td>
                    </tr>
                    <tr>
                        <td>Last Updated</td>
                        <td>${parameter.last_updated ? formatDate(parameter.last_updated) : 'Unknown'}</td>
                    </tr>
                    <tr>
                        <td>Created</td>
                        <td>${parameter.created ? formatDate(parameter.created) : 'Unknown'}</td>
                    </tr>
                    <tr>
                        <td>User Editable</td>
                        <td>${parameter.is_editable !== false ? 'Yes' : 'No'}</td>
                    </tr>
                </table>
            </div>
        `;
        
        // Fetch impact information
        fetch(`/api/admin/parameters/impact/${encodeURIComponent(parameter.path)}`)
            .then(response => response.json())
            .then(data => {
                renderParameterImpact(data);
            })
            .catch(error => {
                console.error('Error loading parameter impact:', error);
                document.getElementById('impact-list').innerHTML = 
                    '<li>Unable to load impact information</li>';
            });
    }
    
    // Render parameter history
    function renderParameterHistory(history) {
        const container = document.getElementById('parameter-history');
        
        if (history.length === 0) {
            container.innerHTML = '<p class="text-muted">No history available</p>';
            return;
        }
        
        const table = document.createElement('table');
        table.className = 'table table-sm table-striped';
        
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Value</th>
                    <th>Source</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        const tbody = table.querySelector('tbody');
        
        history.forEach(entry => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${formatDate(entry.timestamp)}</td>
                <td>${formatParameterValue(entry.value)}</td>
                <td>${entry.source || 'system'}</td>
            `;
            
            tbody.appendChild(row);
        });
        
        container.innerHTML = '';
        container.appendChild(table);
    }
    
    // Render parameter impact information
    function renderParameterImpact(impact) {
        const container = document.getElementById('impact-list');
        
        if (!impact || impact.length === 0) {
            container.innerHTML = '<li>No direct impact information available</li>';
            return;
        }
        
        container.innerHTML = '';
        
        impact.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            container.appendChild(li);
        });
    }
    
    // Find related parameters
    function findRelatedParameters(path) {
        fetch(`/api/admin/parameters/related/${encodeURIComponent(path)}`)
            .then(response => response.json())
            .then(data => {
                renderRelatedParameters(data);
            })
            .catch(error => {
                console.error('Error loading related parameters:', error);
                document.getElementById('related-parameters').innerHTML = 
                    '<p class="text-muted">Failed to load related parameters</p>';
            });
    }
    
    // Render related parameters
    function renderRelatedParameters(related) {
        const container = document.getElementById('related-parameters');
        
        if (!related || related.length === 0) {
            container.innerHTML = '<p class="text-muted">No related parameters found</p>';
            return;
        }
        
        container.innerHTML = '';
        
        related.forEach(param => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark me-2 mb-2 p-2';
            badge.textContent = param.path;
            badge.style.cursor = 'pointer';
            
            badge.addEventListener('click', function() {
                const parameter = allParameters.find(p => p.path === param.path);
                if (parameter) {
                    $('#parameterDetailModal').modal('hide');
                    setTimeout(() => {
                        showParameterDetails(parameter);
                    }, 500);
                }
            });
            
            container.appendChild(badge);
        });
    }
    
    // Filter parameters based on search and category
    function filterParameters() {
        const searchTerm = document.getElementById('parameterSearch').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
        const showUserOverrides = document.getElementById('showUserOverrides').checked;
        
        // Apply filters
        const filtered = allParameters.filter(param => {
            // Search term filter
            const matchesSearch = !searchTerm || 
                param.path.toLowerCase().includes(searchTerm) || 
                (param.description && param.description.toLowerCase().includes(searchTerm));
                
            // Category filter
            const matchesCategory = !categoryFilter || param.path.toLowerCase().startsWith(categoryFilter);
            
            // User overrides filter
            const matchesOverride = !showUserOverrides || param.has_overrides;
            
            return matchesSearch && matchesCategory && matchesOverride;
        });
        
        // Update display
        renderParameterGrid(filtered);
    }
    
    // Filter audit log entries
    function filterAuditLog() {
        const searchTerm = document.getElementById('auditSearch').value.toLowerCase();
        const actionFilter = document.getElementById('auditActionFilter').value.toLowerCase();
        
        // Re-fetch with filters
        fetch(`/api/admin/parameters/audit?search=${encodeURIComponent(searchTerm)}&action=${actionFilter}`)
            .then(response => response.json())
            .then(data => {
                renderAuditLog(data);
            })
            .catch(error => {
                console.error('Error filtering audit log:', error);
            });
    }
    
    // Helper Functions
    
    // Format parameter value for display
    function formatParameterValue(value) {
        if (value === null || value === undefined) {
            return '<em>null</em>';
        }
        
        if (typeof value === 'object') {
            return JSON.stringify(value);
        }
        
        if (typeof value === 'number') {
            return value.toLocaleString();
        }
        
        if (typeof value === 'boolean') {
            return value ? 'true' : 'false';
        }
        
        return String(value);
    }
    
    // Parse parameter value from string
    function parseParameterValue(valueStr) {
        // Try to detect the value type
        if (valueStr === 'null' || valueStr === '') {
            return null;
        }
        
        if (valueStr === 'true') {
            return true;
        }
        
        if (valueStr === 'false') {
            return false;
        }
        
        // Check if it's a number
        if (!isNaN(valueStr) && valueStr.trim() !== '') {
            return parseFloat(valueStr);
        }
        
        // Check if it's JSON
        try {
            if ((valueStr.startsWith('{') && valueStr.endsWith('}')) || 
                (valueStr.startsWith('[') && valueStr.endsWith(']'))) {
                return JSON.parse(valueStr);
            }
        } catch (e) {
            // Not valid JSON, continue as string
        }
        
        // Default to string
        return valueStr;
    }
    
    // Format category name for display
    function formatCategoryName(category) {
        return category
            .replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
    }
    
    // Get parameter name from path
    function getParameterName(path) {
        const parts = path.split('.');
        return formatCategoryName(parts[parts.length - 1]);
    }
    
    // Format date for display
    function formatDate(dateStr) {
        if (!dateStr) return 'Unknown';
        
        try {
            const date = new Date(dateStr);
            return date.toLocaleString();
        } catch (e) {
            return dateStr;
        }
    }
    
    // Convert tree object to D3 hierarchical data
    function convertToTreeData(tree, path = '') {
        if (typeof tree !== 'object' || tree === null) {
            return {
                name: path.split('.').pop() || 'root',
                path: path,
                value: tree
            };
        }
        
        return {
            name: path.split('.').pop() || 'root',
            path: path,
            children: Object.keys(tree).map(key => {
                const childPath = path ? `${path}.${key}` : key;
                return convertToTreeData(tree[key], childPath);
            })
        };
    }
    
    // Create graph data for D3 force-directed visualization
    function createGraphData(tree) {
        const nodes = [];
        const links = [];
        const existingNodes = new Set();
        
        function processNode(node, parent = null, pathSoFar = '') {
            // Skip if we've already processed this node
            if (existingNodes.has(pathSoFar)) {
                return;
            }
            
            // Create node
            const isLeaf = typeof node !== 'object' || node === null;
            const nodeName = pathSoFar.split('.').pop() || 'root';
            
            const nodeObj = {
                id: pathSoFar || 'root',
                name: nodeName,
                isLeaf: isLeaf
            };
            
            if (isLeaf) {
                nodeObj.value = node;
            }
            
            nodes.push(nodeObj);
            existingNodes.add(pathSoFar);
            
            // Create link to parent
            if (parent) {
                links.push({
                    source: parent,
                    target: pathSoFar
                });
            }
            
            // Process children for non-leaf nodes
            if (!isLeaf) {
                Object.keys(node).forEach(key => {
                    const childPath = pathSoFar ? `${pathSoFar}.${key}` : key;
                    processNode(node[key], pathSoFar, childPath);
                });
            }
        }
        
        // Start processing from the root
        processNode(tree);
        
        // Limit the number of nodes to prevent performance issues
        const MAX_NODES = 100;
        if (nodes.length > MAX_NODES) {
            // Prioritize leaf nodes
            const leafNodes = nodes.filter(n => n.isLeaf);
            const nonLeafNodes = nodes.filter(n => !n.isLeaf);
            
            // Keep all leaves and fill remaining slots with non-leaf nodes
            const keptLeaves = leafNodes.slice(0, MAX_NODES);
            const remainingSlots = MAX_NODES - keptLeaves.length;
            const keptNonLeaves = nonLeafNodes.slice(0, remainingSlots);
            
            const keptNodes = [...keptLeaves, ...keptNonLeaves];
            const keptNodeIds = new Set(keptNodes.map(n => n.id));
            
            // Filter links to only include those between kept nodes
            const filteredLinks = links.filter(link => 
                keptNodeIds.has(link.source) && keptNodeIds.has(link.target));
                
            return { nodes: keptNodes, links: filteredLinks };
        }
        
        return { nodes, links };
    }
    
    // Get color for graph node
    function getNodeColor(node) {
        if (!node.isLeaf) {
            return '#6c757d'; // Category nodes
        }
        
        // Color leaf nodes by type
        switch (typeof node.value) {
            case 'number': return '#007bff';
            case 'string': return '#28a745';
            case 'boolean': return '#fd7e14';
            case 'object': return '#6f42c1';
            default: return '#dc3545';
        }
    }
</script>
{% endblock %}